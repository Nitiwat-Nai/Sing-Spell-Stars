<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Mind Match: Jingle Bells</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #1a1a2e; /* Dark background for karaoke feel */
            color: #ffffff;
            text-align: center;
        }
        h1 {
            color: #ffeb3b;
        }
        button#playButton {
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #45a049;
        }
        #lyrics-container {
            margin-top: 30px;
            padding: 20px;
            background-color: #313154;
            border-radius: 10px;
            width: 85%;
            max-width: 800px;
            min-height: 150px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        .lyric-line {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .word {
            transition: color 0.1s;
            margin-right: 5px;
            padding-bottom: 2px;
            display: inline-block;
        }
        .highlighted {
            color: #ffeb3b; /* Bright yellow for highlight */
            text-shadow: 0 0 10px rgba(255, 235, 59, 0.7);
        }
        .guess-word {
            color: #ff4081; /* Pink for word to guess */
            border-bottom: 3px dashed #ff4081; /* ‡∏Ç‡∏µ‡∏î‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏ï‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÄ‡∏î‡∏≤ */
            cursor: help;
        }
        #status {
            margin-top: 20px;
            font-size: 1.1em;
        }
        #score-display {
            font-size: 1.5em;
            color: #2196F3;
            margin-top: 10px;
        }
        #choices-container {
            min-height: 50px;
        }
        .choice-button {
            padding: 10px 20px;
            font-size: 1em;
            margin: 5px;
            background-color: #FFC107;
            color: #333;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .choice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #summary-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            color: #333;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .summary-item {
            padding: 5px 0;
            border-bottom: 1px dotted #ccc;
            text-align: left;
        }
        .summary-item .status {
            font-weight: bold;
            margin-right: 10px;
        }
        .correct-ans { color: #4CAF50; }
        .wrong-ans { color: #F44336; }
    </style>
</head>
<body>

    <h1>üé§ Melody Mind Match: Jingle Bells</h1>
    <button id="playButton">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞</button>
    
    <div id="score-display">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</div>
    
    <div id="lyrics-container">
        </div>
    
    <div id="choices-container">
        </div>

    <div id="status">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</div>
    
    <div id="summary-modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>üìú ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏õ</h2>
        <div id="summary-list">
          </div>
        <p style="margin-top: 15px;">**‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢:** <span id="final-score" style="font-size: 1.2em; font-weight: bold;"></span></p>
      </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÇ‡∏ô‡πâ‡∏ï‡∏î‡∏ô‡∏ï‡∏£‡∏µ
        // ----------------------------------------------------
        let audioContext;
        let isPlaying = false;
        const tempo = 120; // 120 BPM
        const secondsPerBeat = 60 / tempo;
        let score = 0;
        let currentGapIndex = 0; // Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        let musicStartTime = 0;
        let totalWordIndex = 0; // Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° 'R')
        const guessResults = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏≤‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå

        // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (Frequency) ‡∏Ç‡∏≠‡∏á‡πÇ‡∏ô‡πâ‡∏ï‡∏î‡∏ô‡∏ï‡∏£‡∏µ 
        const noteFrequencies = {
            'C3': 130.81, 'D3': 146.83, 'E3': 164.81, 'F3': 174.61, 'G3': 196.00, 'A3': 220.00, 'B3': 246.94, // 3rd Octave
            'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'Fs4': 369.99, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88, // 4th Octave
            'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, // 5th Octave
            'R': 0 // R = Rest (‡∏´‡∏¢‡∏∏‡∏î)
        };

        // ----------------------------------------------------
        // 2. ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏•‡∏á (Melody, Lyrics, Gaps) - ‡∏ï‡∏≤‡∏°‡πÇ‡∏ô‡πâ‡∏ï‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡πâ‡∏°‡∏≤
        // ----------------------------------------------------
        
        // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á: [‡πÇ‡∏ô‡πâ‡∏ï, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞, '‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå', ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà, {‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏≤}]
        const songData = [
            // --- Line 1: Dashing through the snow, in a one-horse open sleigh.
            ['D4', 0.5, 'Dash', false], ['B3', 0.5, 'ing', false], ['A3', 0.5, 'through', false], ['G3', 0.5, 'the', false], ['D4', 0.5, 'snow,', true, { correct: 'snow', choices: ['snow', 'slow'] }], ['R', 0.5, '', false],
            ['D4', 0.5, 'in', false], ['D4', 0.5, 'a', false], ['D4', 0.5, 'one-', false], ['B3', 0.5, 'horse', false], ['A3', 0.5, 'open', false], ['G3', 0.5, 'sleigh.', false], ['R', 1.0, '', false], 
            
            // --- Line 2: O'er the fields we go, laughing all the way;
            ['E4', 0.5, "O'er", false], ['C4', 0.5, 'the', false], ['B3', 0.5, 'fields', false], ['A3', 0.5, 'we', false], ['Fs4', 0.5, 'go,', true, { correct: 'go', choices: ['go', 'grew'] }], ['R', 0.5, '', false], 
            ['D4', 0.5, 'laugh', false], ['D4', 0.5, 'ing', false], ['C4', 0.5, 'all', false], ['A3', 0.5, 'the', false], ['B3', 0.5, 'way;', false], ['R', 0.5, '', false],

            // --- Line 3: Bells on bob-tail ring, making spirits bright,
            ['D4', 0.5, 'Bells', false], ['B3', 0.5, 'on', false], ['A3', 0.5, 'bob-', false], ['G3', 0.5, 'tail', false], ['D4', 0.5, 'ring,', true, { correct: 'ring', choices: ['ring', 'wring'] }], ['R', 0.5, '', false],
            ['D4', 0.5, 'mak', false], ['D4', 0.5, 'ing', false], ['B3', 0.5, 'spir', false], ['A3', 0.5, 'its', false], ['G3', 0.5, 'bright,', false], ['R', 0.5, '', false],
            
            // --- Line 4: What fun it is to ride and sing a sleighing song to-night! Oh!
            ['E4', 0.5, 'what', false], ['E4', 0.5, 'fun', false], ['C4', 0.5, 'it', false], ['E4', 0.5, 'is', false], ['E4', 0.5, 'to', false], ['C4', 0.5, 'ride', false], ['B3', 0.5, 'and', false], ['A3', 0.5, 'sing', false], 
            ['D4', 0.5, 'a', false], ['D4', 0.5, 'sleigh', false], ['D4', 0.5, 'ing', false], ['E4', 0.5, 'song', false], ['C4', 0.5, 'to-', false], ['A3', 0.5, 'night!', false], ['G3', 1.0, 'Oh!', false], ['R', 1.0, '', false], 

            // --- Line 5: Jingle bells, jingle bells, jingle all the way! Oh, what fun it 
            ['B3', 0.5, 'Jin', false], ['B3', 0.5, 'gle', false], ['B3', 0.5, 'bells,', false], ['B3', 0.5, 'jin', false], ['B3', 0.5, 'gle', false], ['B3', 0.5, 'bells,', true, { correct: 'bells', choices: ['bells', 'balls'] }], ['R', 0.5, '', false], 
            ['B3', 0.5, 'jin', false], ['D4', 0.5, 'gle', false], ['G3', 0.5, 'all', false], ['A3', 0.5, 'the', false], ['B3', 1.0, 'way!', false], ['B3', 0.5, 'Oh,', false], ['B3', 0.5, 'what', false], ['B3', 0.5, 'fun', false], ['B3', 0.5, 'it', false], 
            
            // --- Line 6: is to ride in a one horse open sleigh! Hey!
            ['B3', 0.5, 'is', false], ['A3', 0.5, 'to', false], ['A3', 0.5, 'ride', false], ['A3', 0.5, 'in', false], ['A3', 0.5, 'a', false], ['B3', 0.5, 'one', false], ['A3', 0.5, 'horse', false], ['B3', 0.5, 'open', false], 
            ['D4', 0.5, 'sleigh!', false], ['B3', 0.5, 'Hey!', false], ['R', 1.0, '', false], ['R', 0.5, '', false],

            // --- Line 7: Jingle bells, jingle bells, jingle all the way! Oh, what fun it 
            ['C4', 0.5, 'Jin', false], ['C4', 0.5, 'gle', false], ['C4', 0.5, 'bells,', false], ['C4', 0.5, 'jin', false], ['C4', 0.5, 'gle', false], ['C4', 0.5, 'bells,', false], ['R', 0.5, '', false], 
            ['B3', 0.5, 'jin', false], ['B3', 0.5, 'gle', false], ['B3', 0.5, 'all', false], ['B3', 0.5, 'the', false], ['A3', 1.0, 'way!', true, { correct: 'way', choices: ['way', 'weigh'] }], ['B3', 0.5, 'Oh,', false], ['B3', 0.5, 'what', false], ['B3', 0.5, 'fun', false], ['B3', 0.5, 'it', false], 
            
            // --- Line 8: is to ride in a one horse open sleigh!
            ['C4', 0.5, 'is', false], ['C4', 0.5, 'to', false], ['B3', 0.5, 'ride', false], ['B3', 0.5, 'in', false], ['B3', 0.5, 'a', false], ['D4', 0.5, 'one', false], ['D4', 0.5, 'horse', false], ['C4', 0.5, 'open', false], 
            ['G3', 2.0, 'sleigh!', false], // ‡∏à‡∏ö‡πÄ‡∏û‡∏•‡∏á
        ];

        // ----------------------------------------------------
        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Play Note)
        // ----------------------------------------------------
        
        function playNote(frequency, startTime, duration) {
            if (frequency === 0) return; 

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'triangle'; 
            oscillator.frequency.setValueAtTime(frequency, startTime);

            const attackTime = 0.01;
            const releaseTime = 0.1;

            // ADSR Envelope
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(0.5, startTime + attackTime); 
            gainNode.gain.linearRampToValueAtTime(0.5, startTime + duration - releaseTime);
            gainNode.gain.linearRampToValueAtTime(0, startTime + duration); 

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        }

        // ----------------------------------------------------
        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Lyrics, UI, Guessing)
        // ----------------------------------------------------
        
        function initializeLyrics() {
            const container = document.getElementById('lyrics-container');
            container.innerHTML = '';
            
            // ‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡πà‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡∏≤‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏û‡∏•‡∏á
            const lines = [
                songData.slice(0, 13),   
                songData.slice(13, 25), 
                songData.slice(25, 37), 
                songData.slice(37, 53), 
                songData.slice(53, 69), 
                songData.slice(69, 81), 
                songData.slice(81, 97), 
                songData.slice(97, 105), 
            ];

            let wordCounter = 0; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏≤ (Gap words)
            totalWordIndex = 0; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Word tracking)

            lines.forEach((lineData) => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'lyric-line';
                
                lineData.forEach(([note, duration, word, isGap, gapData]) => {
                    if (word && word !== 'R') { 
                        const wordSpan = document.createElement('span');
                        wordSpan.className = 'word';
                        wordSpan.textContent = word.replace('R', '') + ' ';
                        
                        if (isGap) {
                            wordSpan.id = 'gap-word-' + wordCounter;
                            wordSpan.classList.add('guess-word');
                            wordSpan.textContent = '____ '; 
                            wordSpan.dataset.index = wordCounter;
                            wordSpan.dataset.correct = gapData.correct;
                            wordSpan.dataset.choices = JSON.stringify(gapData.choices);
                            wordSpan.dataset.guessed = 'false'; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏≤
                            wordCounter++;
                        } else {
                            wordSpan.id = 'synced-word-' + totalWordIndex;
                        }
                        
                        lineDiv.appendChild(wordSpan);
                        totalWordIndex++;
                    }
                });
                container.appendChild(lineDiv);
            });
            currentGapIndex = 0; // Reset index for actual playback logic
        }

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
         */
        function updateLyrics(index, delay) {
            setTimeout(() => {
                // 1. ‡∏•‡∏ö‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏Ñ‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                const previousWordElement = document.querySelector(`.lyric-line .highlighted`);
                if (previousWordElement) {
                    previousWordElement.classList.remove('highlighted');
                }

                const [note, duration, word, isGap, gapData] = songData[index];
                
                if (word && word !== 'R') {
                    let wordElement = null;
                    
                    // 2. ‡∏´‡∏≤ Element ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    if (isGap) {
                        wordElement = document.getElementById('gap-word-' + currentGapIndex);
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞
                        if (wordElement) showChoices(wordElement);
                    } else {
                        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà R ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Gap
                        let textIndex = 0;
                        for (let i = 0; i < songData.length; i++) {
                            const [n, d, w, iG] = songData[i];
                            if (w && w !== 'R') {
                                if (i === index) {
                                    // ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô DOM ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ ID ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
                                    wordElement = document.getElementById('synced-word-' + textIndex);
                                    break;
                                }
                                textIndex++;
                            }
                        }
                    }
                    
                    // 3. ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏Ñ‡∏≥‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    if (wordElement) {
                         wordElement.classList.add('highlighted');
                    }
                }
                
                // 4. ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
                if (isGap) {
                    // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏î‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÇ‡∏ô‡πâ‡∏ï‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏≤‡∏ú‡∏¥‡∏î
                    const gapElement = document.getElementById('gap-word-' + currentGapIndex);
                    if (gapElement && gapElement.dataset.guessed === 'false') {
                         handleTimeout(gapElement);
                    }
                    currentGapIndex++;
                }

            }, delay);
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
         */
        function showChoices(wordElement) {
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = ''; 
            
            const choices = JSON.parse(wordElement.dataset.choices);
            const correctWord = wordElement.dataset.correct;

            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button';
                button.textContent = choice;
                button.onclick = () => handleGuess(button, choice, correctWord, wordElement);
                choicesContainer.appendChild(button);
            });
        }

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
         */
        function handleTimeout(wordElement) {
            score -= 1; 
            document.getElementById('score-display').textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`;
            wordElement.textContent = wordElement.dataset.correct + ' '; 
            wordElement.style.color = '#F44336'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
            wordElement.style.borderBottom = 'none'; // ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞
            wordElement.dataset.guessed = 'true';

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            guessResults.push({
                word: wordElement.dataset.correct,
                status: '‡∏ú‡∏¥‡∏î',
                message: '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ö (-1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)',
                correct: wordElement.dataset.correct
            });
            document.getElementById('choices-container').innerHTML = '';
        }

        /**
         * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
         */
        function handleGuess(button, guessedWord, correctWord, wordElement) {
            if (wordElement.dataset.guessed === 'true') return; // ‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥

            wordElement.dataset.guessed = 'true';
            const allChoiceButtons = document.getElementById('choices-container').querySelectorAll('.choice-button');
            allChoiceButtons.forEach(btn => btn.disabled = true); // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

            let resultStatus;

            if (guessedWord === correctWord) {
                score += 10; 
                resultStatus = '‡∏ñ‡∏π‡∏Å';
                wordElement.textContent = correctWord + ' ';
                wordElement.style.color = '#8BC34A'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                wordElement.style.borderBottom = 'none';
            } else {
                score -= 1; 
                resultStatus = '‡∏ú‡∏¥‡∏î';
                wordElement.textContent = correctWord + ' '; 
                wordElement.style.color = '#F44336'; // ‡∏™‡∏µ‡πÅ‡∏î‡∏á
                wordElement.style.borderBottom = 'none';
                
            }

            document.getElementById('score-display').textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`;
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            guessResults.push({
                word: correctWord,
                status: resultStatus,
                message: resultStatus === '‡∏ñ‡∏π‡∏Å' ? '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å (+10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)' : `‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î (-1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ${guessedWord}`,
                correct: correctWord
            });

            // ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≠‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢
            setTimeout(() => {
                document.getElementById('choices-container').innerHTML = '';
            }, 500);
        }

        // ----------------------------------------------------
        // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
        // ----------------------------------------------------
        
        function showSummary() {
            const modal = document.getElementById('summary-modal');
            const summaryList = document.getElementById('summary-list');
            const finalScore = document.getElementById('final-score');
            
            summaryList.innerHTML = '';
            finalScore.textContent = score;

            if (guessResults.length === 0) {
                 summaryList.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏î‡∏≤‡πÉ‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏ô‡∏µ‡πâ</p>';
            } else {
                 guessResults.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'summary-item';
                    const statusClass = item.status === '‡∏ñ‡∏π‡∏Å' ? 'correct-ans' : 'wrong-ans';
                    
                    div.innerHTML = `<span class="status ${statusClass}">${item.status}:</span> 
                                     **${item.correct}** (${item.message})`;
                    summaryList.appendChild(div);
                 });
            }
            
            modal.style.display = "block";
        }
        
        // ----------------------------------------------------
        // 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å
        // ----------------------------------------------------

        function startGame() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            if (isPlaying) return;
            isPlaying = true;
            score = 0;
            currentGapIndex = 0;
            guessResults.length = 0;
            document.getElementById('score-display').textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0';
            document.getElementById('playButton').disabled = true;
            document.getElementById('choices-container').innerHTML = ''; 
            document.getElementById('summary-modal').style.display = "none"; // ‡∏õ‡∏¥‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ

            musicStartTime = audioContext.currentTime;
            let currentTime = musicStartTime;
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á
            initializeLyrics();

            songData.forEach(([noteName, lengthInBeats, word, isGap, gapData], index) => {
                const frequency = noteFrequencies[noteName];
                const duration = lengthInBeats * secondsPerBeat;
                
                // 1. ‡πÄ‡∏•‡πà‡∏ô‡πÇ‡∏ô‡πâ‡∏ï‡∏î‡∏ô‡∏ï‡∏£‡∏µ
                playNote(frequency, currentTime, duration);
                
                // 2. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á
                const delayMs = (currentTime - musicStartTime) * 1000;
                updateLyrics(index, delayMs);
                
                // 3. ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                currentTime += duration;
            });

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏ö
            document.getElementById('status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô...';
            const totalDuration = currentTime - musicStartTime;

            setTimeout(() => {
                isPlaying = false;
                document.getElementById('playButton').disabled = false;
                document.getElementById('status').textContent = `‡∏à‡∏ö‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•...`;
                showSummary(); // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•
            }, totalDuration * 1000 + 300); 
        }

        // ----------------------------------------------------
        // 7. Event Listener ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        // ----------------------------------------------------
        document.getElementById('playButton').addEventListener('click', startGame);
        document.getElementById('status').textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô';
        initializeLyrics(); 
        
        // ‡∏õ‡∏¥‡∏î Modal ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° x ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö
        const modal = document.getElementById('summary-modal');
        const closeBtn = document.getElementsByClassName("close")[0];
        closeBtn.onclick = function() {
          modal.style.display = "none";
        }
        window.onclick = function(event) {
          if (event.target == modal) {
            modal.style.display = "none";
          }
        }
    </script>
</body>
</html>
