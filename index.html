<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé§ Sing & Spell Stars (Fixed Loading & Thai Translation)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@600&display=swap');

        body {
            font-family: 'Chakra Petch', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #FFC0CB 0%, #ADD8E6 100%); 
            color: #333;
            text-align: center;
            margin: 0;
            padding: 20px 0;
        }
        .game-section {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { 
            color: #8A2BE2; 
            margin-bottom: 10px; 
            text-shadow: 2px 2px 0 #fff;
        }
        h2 {
            color: #6495ED; 
            margin-bottom: 20px;
        }
        #score-display { 
            font-size: 1.6em; 
            color: #6495ED; 
            margin-top: 15px; 
            font-weight: bold;
        }
        
        /* --- Karaoke Window --- */
        #karaoke-window {
            width: 95%;
            max-width: 900px;
            height: 480px; 
            overflow: hidden; 
            margin: 20px 0;
            background-color: #FFFACD; 
            border-radius: 15px;
            border: 5px solid #6A5ACD;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        #lyrics-container {
            width: 100%;
            transition: transform 0.4s ease-out; 
            padding-top: 100px; 
        }
        
        .lyric-line {
            font-size: 1.8em; 
            font-weight: 600;
            line-height: 1.5;
            padding: 2px 20px;
            transition: color 0.3s, opacity 0.3s;
        }
        .current-line {
            color: #333; 
            opacity: 1;
            transform: scale(1.05);
        }
        .non-current-line {
            color: #A9A9A9; 
            opacity: 0.7;
        }
        .word {
            transition: color 0.1s;
            margin-right: 5px;
            display: inline-block;
        }
        .highlighted {
            color: #FF69B4; 
            text-shadow: 1px 1px 2px #F08080; 
        }
        .guess-word {
            color: #483D8B; 
            border-bottom: 3px dashed #483D8B; 
        }

        /* --- Controls & Menu Button Styles --- */
        #controls-container, #main-menu-page button {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            flex-direction: column; 
        }

        #choices-container {
             display: flex; 
             flex-direction: row; 
             flex-wrap: wrap;
             justify-content: center;
             align-items: center;
             min-height: 60px;
             padding: 10px;
        }

        .menu-button, button#playButton {
            padding: 18px 40px;
            font-size: 1.3em;
            background-color: #9370DB; 
            color: white;
            border: 4px solid #fff;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px #6A5ACD; 
            transition: all 0.1s;
            margin: 10px;
        }
        .menu-button:active, button#playButton:active {
            box-shadow: 0 1px #6A5ACD;
            transform: translateY(4px);
        }
        
        .choice-button {
            padding: 15px 30px;
            font-size: 1.2em;
            margin: 10px 10px; 
            background-color: #B0E0E6; 
            color: #333;
            border: 3px solid #6495ED;
            border-radius: 40px;
            cursor: pointer;
            box-shadow: 0 3px #87CEEB;
            transition: all 0.1s;
            display: none; 
        }
        .choice-button.active {
            display: inline-block;
        }
        
        /* --- Summary Page --- */
        #summary-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100%;
            background: linear-gradient(135deg, #FFC0CB 0%, #ADD8E6 100%); 
            z-index: 1000;
            display: none; 
            padding: 20px;
            box-sizing: border-box;
            color: #333;
            overflow-y: auto;
        }
        .summary-content {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }
        #summary-list {
            margin-top: 20px;
            text-align: left;
        }
        .summary-item { 
            padding: 8px 0; 
            border-bottom: 1px dotted #ccc; 
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
        }
        .summary-word { font-weight: bold; width: 60%; } 
        .summary-status { width: 40%; text-align: right;} 
        .correct-ans { color: #3CB371; } 
        .wrong-ans { color: #FF6347; } 
    </style>
    <script src="https://unpkg.com/midi@1.0.0/dist/midi.min.js"></script>
</head>
<body>
    
    <div id="main-menu-page" class="game-section">
        <h1>üé§ Sing & Spell Stars</h1>
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</h2>
        <div id="song-list-container">
            <button class="menu-button" onclick="loadSongAndStartGame('jinglebells')">üé∂ Jingle Bells (MIDI Sync)</button>
        </div>
    </div>

    <div id="game-page" class="game-section" style="display: none;">
        <h1>üé§ Sing & Spell Stars</h1>
        <h2 id="song-title-display"></h2> 
        
        <div id="score-display">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</div>
        
        <div id="karaoke-window">
            <div id="lyrics-container">
                </div>
        </div>

        <div id="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        
        <div id="controls-container">
             <div id="choices-container">
                </div>
             <div id="start-button-container">
                <button id="playButton" style="display: none;">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞</button>
             </div>
        </div>
    </div>

    <div id="summary-page">
      <div class="summary-content">
        <h2 style="color: #483D8B;">üìú ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h2>
        <div style="font-size: 1.5em; margin-bottom: 20px;">
            **‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢:** <span id="final-score" style="color: #FF69B4;"></span>
        </div>
        <div id="summary-list">
             </div>
        <button onclick="goToMainMenu()" style="margin-top: 30px; background-color: #9370DB; color: white; padding: 15px 30px; border: none; border-radius: 30px; font-size: 1.2em;">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏•‡∏á (MIDI SYNCHRONIZED)
        // ----------------------------------------------------
        let isPlaying = false;
        let score = 0;
        let currentGapIndex = 0; 
        let currentLineIndex = -1;
        const guessResults = []; 
        let currentSongData = null; 
        
        // ** ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î **
        const songsData = {
            "jinglebells": {
                title: "üé∂ Jingle Bells (MIDI Sync)",
                // ‡πÉ‡∏ä‡πâ Local Path (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå Jingle Bells.mid ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
                midiUrl: "Jingle Bells.mid", 
                
                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡∏∞ Gap
                data: [
                    // [‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå, ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏≤, {‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏≤}, Line Index]
                    // ‡∏Ñ‡∏≥/Line 1 (DASHING THROUGH THE SNOW)
                    ['DASHING', false, null, 1], ['THROUGH', false, null, 1], ['THE', false, null, 1], 
                    ['SNOW,', true, { correct: 'SNOW,', choices: ['SNOW,', 'SLOW,'], thai: '‡∏´‡∏¥‡∏°‡∏∞' }, 1], // Gap 1
                    ['IN', false, null, 1], ['ONE-HORSE', false, null, 1], ['OPEN', false, null, 1], 
                    ['SLEIGH,', false, null, 1], 

                    // ‡∏Ñ‡∏≥/Line 2 (O'ER THE FIELDS WE GO)
                    ['O\'ER', false, null, 2], ['THE', false, null, 2], ['FIELDS', false, null, 2], 
                    ['WE', false, null, 2], ['GO,', false, null, 2], 
                    ['LAUGHING', false, null, 2], ['ALL', false, null, 2], ['THE', false, null, 2], 
                    ['WAY.', false, null, 2], 

                    // ‡∏Ñ‡∏≥/Line 3 (BELLS ON BOB-TAIL RING)
                    ['BELLS', true, { correct: 'BELLS', choices: ['BELLS', 'BALLS'], thai: '‡∏Å‡∏£‡∏∞‡∏î‡∏¥‡πà‡∏á' }, 3], // Gap 2
                    ['ON', false, null, 3], ['BOB-TAIL', false, null, 3], ['RING,', false, null, 3], 
                    ['MAKING', false, null, 3], ['SPIRITS', false, null, 3], ['BRIGHT;', false, null, 3], 
                    
                    // ‡∏Ñ‡∏≥/Line 4 & 5 (WHAT FUN IT IS TO RIDE AND SING)
                    ['WHAT', false, null, 4], ['FUN', false, null, 4], ['IT', false, null, 4], 
                    ['IS', false, null, 4], ['TO', false, null, 4], ['RIDE', false, null, 4], 
                    ['AND', false, null, 5], 
                    ['SING', true, { correct: 'SING', choices: ['SING', 'SINK'], thai: '‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á' }, 5], // Gap 3
                    ['A', false, null, 5], ['SLEIGHING', false, null, 5], ['SONG', false, null, 5], 
                    ['TONIGHT.', false, null, 5], 
                    
                    // ‡∏Ñ‡∏≥/Line 6 - 8 (CHORUS 1)
                    ['JINGLE', false, null, 6], ['BELLS!', false, null, 6], 
                    ['JINGLE', false, null, 7], ['BELLS!', false, null, 7], 
                    ['JINGLE', false, null, 8], ['ALL', false, null, 8], ['THE', false, null, 8], 
                    ['WAY!', true, { correct: 'WAY!', choices: ['WAY!', 'HEY!'], thai: '‡∏ó‡∏≤‡∏á' }, 8], // Gap 4
                    
                    // ‡∏Ñ‡∏≥/Line 9 - 10 (OH! WHAT FUN IT IS TO RIDE)
                    ['OH!', false, null, 9], ['WHAT', false, null, 9], ['FUN', false, null, 9], 
                    ['IT', false, null, 9], ['IS', false, null, 9], ['TO', false, null, 9], ['RIDE', false, null, 9], 
                    ['IN', false, null, 10], ['A', false, null, 10], ['ONE-HORSE', false, null, 10], 
                    ['OPEN', false, null, 10], ['SLEIGH', false, null, 10], [',OH!', false, null, 10], 
                    
                    // ‡∏Ñ‡∏≥/Line 11 - 13 (CHORUS 2 - Repeat)
                    ['JINGLE', false, null, 11], ['BELLS!', false, null, 11],
                    ['JINGLE', false, null, 12], ['BELLS!', false, null, 12], 
                    ['JINGLE', false, null, 13], ['ALL', false, null, 13], ['THE', false, null, 13], 
                    ['WAY!', false, null, 13],
                ]
            }
        };

        // ----------------------------------------------------
        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏•‡∏¢‡πå
        // ----------------------------------------------------
        
        function initializeLyrics(songData) {
            const container = document.getElementById('lyrics-container');
            container.innerHTML = '';
            
            const linesData = {};
            songData.data.forEach(item => {
                const lineIndex = item[item.length - 1]; 
                if (!linesData[lineIndex]) {
                    linesData[lineIndex] = [];
                }
                linesData[lineIndex].push(item);
            });
            
            let wordCounter = 0;
            
            Object.keys(linesData).sort((a, b) => a - b).forEach(lineIndex => {
                const lineData = linesData[lineIndex];
                const lineDiv = document.createElement('div');
                lineDiv.className = 'lyric-line non-current-line';
                lineDiv.id = 'line-' + lineIndex;
                
                lineData.forEach(([word, isGap, gapData]) => {
                    if (word) { 
                        const wordSpan = document.createElement('span');
                        wordSpan.className = 'word';
                        wordSpan.textContent = word + ' ';
                        
                        if (isGap) {
                            wordSpan.id = 'gap-word-' + wordCounter;
                            wordSpan.classList.add('guess-word');
                            wordSpan.textContent = '____ '; 
                            wordSpan.dataset.index = wordCounter;
                            wordSpan.dataset.correct = gapData.correct;
                            wordSpan.dataset.choices = JSON.stringify(gapData.choices);
                            wordSpan.dataset.thai = gapData.thai; 
                            wordSpan.dataset.guessed = 'false'; 
                            wordCounter++;
                        } else {
                            wordSpan.id = 'synced-word-' + wordCounter; 
                        }
                        
                        lineDiv.appendChild(wordSpan);
                    }
                });
                container.appendChild(lineDiv);
            });
            currentGapIndex = 0;
            
            const firstLine = document.getElementById('line-1');
            if(firstLine) {
                 firstLine.classList.remove('non-current-line');
                 firstLine.classList.add('current-line');
                 currentLineIndex = 1;
            }
        }

        function highlightWord(index, lineIdx) {
            const previousWordElement = document.querySelector(`.lyric-line .highlighted`);
            if (previousWordElement) {
                previousWordElement.classList.remove('highlighted');
            }

            // --- Scrolling Logic ---
            if (lineIdx && lineIdx !== currentLineIndex) {
                const newLineElement = document.getElementById('line-' + lineIdx);
                const oldLineElement = document.getElementById('line-' + currentLineIndex);
                
                if(oldLineElement) {
                    oldLineElement.classList.remove('current-line');
                    oldLineElement.classList.add('non-current-line');
                }
                
                if (newLineElement) {
                    const lineTop = newLineElement.offsetTop;
                    const scrollOffset = 240; 
                    const scrollAmount = lineTop - scrollOffset;
                    
                    document.getElementById('lyrics-container').style.transform = `translateY(-${Math.max(0, scrollAmount)}px)`;
                    
                    newLineElement.classList.add('current-line');
                    newLineElement.classList.remove('non-current-line');
                    currentLineIndex = lineIdx;
                }
            }

            // --- Highlighting ---
            const wordData = currentSongData.data[index];
            const isGap = wordData[1];
            
            let wordElement = null;
            
            if (isGap) {
                wordElement = document.getElementById('gap-word-' + currentGapIndex);
            } else {
                wordElement = document.getElementById('synced-word-' + index);
            }
            
            if (wordElement) {
                wordElement.classList.add('highlighted');
            }
        }
        
        function handleGapWord(wordIndex, durationMs) {
            const gapElement = document.getElementById('gap-word-' + currentGapIndex);
            
            if (gapElement) {
                const choices = JSON.parse(gapElement.dataset.choices);
                const correct = gapElement.dataset.correct;
                showChoices(gapElement, choices, correct);
            }
            
            setTimeout(() => {
                if (gapElement && gapElement.dataset.guessed === 'false') {
                    handleTimeout(gapElement);
                }
                currentGapIndex++; 
            }, durationMs);
        }
        
        // ----------------------------------------------------
        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡πÇ‡∏Ñ‡∏£‡πÑ‡∏ô‡∏ã‡πå (MIDI Player)
        // ----------------------------------------------------

        function setupMIDISync() {
            // MIDI.js ‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î soundfont ‡∏Å‡πà‡∏≠‡∏ô (‡πÉ‡∏ä‡πâ soundfont ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤)
            MIDI.loadPlugin({
                // **** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç SoundFont URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£ ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏´‡∏•‡∏î 0% ****
                soundfontUrl: "https://gleitz.github.io/midi-js-soundfonts/FluidR3_GM/", 
                // ************************************************************
                instrument: "acoustic_grand_piano",
                onprogress: function(state, progress) {
                    document.getElementById('status').textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏ô‡∏ï‡∏£‡∏µ: ${Math.round(progress * 100)}%`;
                },
                onsuccess: function() {
                    document.getElementById('status').textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏•‡πà‡∏ô MIDI';
                    document.getElementById('playButton').style.display = 'block';
                    
                    MIDI.Player.loadFile(currentSongData.midiUrl, function() {
                        const noteEvents = MIDI.Player.data.trackEvents.flat();
                        
                        let noteTimestamps = [];
                        noteEvents.forEach(track => {
                             track.forEach(event => {
                                if (event.event.type === 'noteOn' && event.event.velocity > 0) {
                                    noteTimestamps.push({ 
                                        time: event.time, 
                                        duration: event.event.duration || 0.2, 
                                        note: event.event.note 
                                    });
                                }
                            });
                        });
                        
                        noteTimestamps.sort((a, b) => a.time - b.time);
                        
                        let syncMap = [];
                        let lyricsIndex = 0;
                        const melodyNotes = noteTimestamps.filter(n => n.note >= 60); 

                        for (let i = 0; i < currentSongData.data.length && lyricsIndex < melodyNotes.length; i++) {
                            syncMap.push({
                                time: melodyNotes[lyricsIndex].time,
                                duration: melodyNotes[lyricsIndex].duration * 1000, 
                                data: currentSongData.data[i] 
                            });
                            lyricsIndex++;
                        }

                        document.getElementById('playButton').onclick = function() {
                            startGameMIDISync(syncMap);
                        };
                    });
                }
            });
        }
        
        function startGameMIDISync(syncMap) {
            if (isPlaying) return;
            isPlaying = true;
            score = 0;
            currentGapIndex = 0;
            currentLineIndex = 1;
            guessResults.length = 0;
            
            document.getElementById('score-display').textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0';
            document.getElementById('status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô...';
            document.getElementById('start-button-container').style.display = 'none';
            document.getElementById('choices-container').style.display = 'flex';

            initializeLyrics(currentSongData);

            MIDI.Player.start();

            syncMap.forEach((item, index) => {
                const [word, isGap, gapData, lineIdx] = item.data;
                const delayMs = item.time * 1000;
                const durationMs = item.duration;

                setTimeout(() => {
                    highlightWord(index, lineIdx); 

                    if (isGap) {
                        handleGapWord(index, durationMs);
                    }
                }, delayMs);
            });

            MIDI.Player.addListener(function(data) {
                if (data.status === 'end') {
                    isPlaying = false;
                    document.getElementById('status').textContent = `‡∏à‡∏ö‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•...`;
                    document.getElementById('choices-container').innerHTML = '';
                    setTimeout(showSummary, 500); 
                }
            });
        }

        // ----------------------------------------------------
        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Guess ‡πÅ‡∏•‡∏∞ Summary
        // ----------------------------------------------------
        function showChoices(wordElement, choices, correctWord) {
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = ''; 
            
            const thaiMeaning = wordElement.dataset.thai;
            const instructionDiv = document.createElement('div');
            instructionDiv.style.marginBottom = '15px';
            instructionDiv.style.fontSize = '1.1em';
            instructionDiv.style.fontWeight = 'bold';
            instructionDiv.style.color = '#483D8B';
            instructionDiv.textContent = `‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏¥‡∏° (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢: ${thaiMeaning})`;
            choicesContainer.appendChild(instructionDiv);
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button active'; 
                button.textContent = choice;
                button.onclick = () => handleGuess(button, choice, correctWord, wordElement);
                choicesContainer.appendChild(button);
            });
        }

        function handleTimeout(wordElement) {
            score -= 1; 
            document.getElementById('score-display').textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`;
            wordElement.textContent = wordElement.dataset.correct + ' '; 
            wordElement.style.color = '#FF6347'; 
            wordElement.style.borderBottom = 'none'; 
            wordElement.dataset.guessed = 'true';
            guessResults.push({ word: wordElement.dataset.correct, thai: wordElement.dataset.thai, status: '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤', message: '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ö', correct: wordElement.dataset.correct });
            document.getElementById('choices-container').innerHTML = '';
        }

        function handleGuess(button, guessedWord, correctWord, wordElement) {
            if (wordElement.dataset.guessed === 'true') return;
            wordElement.dataset.guessed = 'true';
            document.getElementById('choices-container').querySelectorAll('.choice-button').forEach(btn => btn.disabled = true);
            let resultStatus;
            if (guessedWord === correctWord) {
                score += 10; resultStatus = '‡∏ñ‡∏π‡∏Å';
                wordElement.textContent = correctWord + ' ';
                wordElement.style.color = '#3CB371'; wordElement.style.borderBottom = 'none';
            } else {
                score -= 1; resultStatus = '‡∏ú‡∏¥‡∏î';
                wordElement.textContent = correctWord + ' '; 
                wordElement.style.color = '#FF6347'; wordElement.style.borderBottom = 'none';
            }
            document.getElementById('score-display').textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`;
            guessResults.push({ word: correctWord, thai: wordElement.dataset.thai, status: resultStatus, message: resultStatus === '‡∏ñ‡∏π‡∏Å' ? '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å' : '‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î', correct: correctWord });
            document.getElementById('choices-container').innerHTML = '';
        }

        function showSummary() {
            document.getElementById('game-page').style.display = 'none';
            const summaryPage = document.getElementById('summary-page');
            summaryPage.style.display = 'flex';
            const summaryList = document.getElementById('summary-list');
            const finalScore = document.getElementById('final-score');
            summaryList.innerHTML = '';
            finalScore.textContent = score;

            const headerDiv = document.createElement('div');
            headerDiv.className = 'summary-item';
            headerDiv.style.fontWeight = 'bold';
            headerDiv.innerHTML = `<span class="summary-word">‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•)</span><span class="summary-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>`;
            summaryList.appendChild(headerDiv);

            guessResults.forEach(item => {
                const div = document.createElement('div');
                div.className = 'summary-item';
                const statusClass = item.status === '‡∏ñ‡∏π‡∏Å' ? 'correct-ans' : 'wrong-ans';
                let displayStatus = (item.status === '‡∏ñ‡∏π‡∏Å' ? '‡∏ñ‡∏π‡∏Å' : (item.status === '‡∏ú‡∏¥‡∏î' ? '‡∏ú‡∏¥‡∏î' : '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤'));

                div.innerHTML = `<span class="summary-word">${item.word} **(${item.thai})**</span>
                                 <span class="summary-status ${statusClass}">${displayStatus}</span>`;
                summaryList.appendChild(div);
            });
        }
        
        function goToMainMenu() {
            document.getElementById('summary-page').style.display = 'none';
            document.getElementById('game-page').style.display = 'none';
            document.getElementById('main-menu-page').style.display = 'flex'; 
            
            if (MIDI.Player && MIDI.Player.data) {
                MIDI.Player.stop();
            }
            
            currentSongData = null;
            document.getElementById('score-display').textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0';
            document.getElementById('status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
            document.getElementById('choices-container').innerHTML = '';
            document.getElementById('playButton').style.display = 'none'; 
        }

        // ----------------------------------------------------
        // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        // ----------------------------------------------------

        function loadSongAndStartGame(songKey) {
            currentSongData = songsData[songKey];
            
            document.getElementById('main-menu-page').style.display = 'none';
            document.getElementById('game-page').style.display = 'flex';
            document.getElementById('summary-page').style.display = 'none';
            
            document.getElementById('song-title-display').textContent = currentSongData.title;
            
            document.getElementById('start-button-container').style.display = 'block'; 
            document.getElementById('choices-container').style.display = 'none';
            
            initializeLyrics(currentSongData); 
            document.getElementById('lyrics-container').style.transform = `translateY(0)`;
            
            setupMIDISync();
        }

        // ----------------------------------------------------
        // 6. ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        // ----------------------------------------------------
        goToMainMenu(); 
    </script>
</body>
</html>
