<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé§ Sing & Spell Stars</title>
    <style>
        /* --- ‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏• (Pastel Theme) --- */
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@600&display=swap');

        body {
            font-family: 'Chakra Petch', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #FFC0CB 0%, #ADD8E6 100%); 
            color: #333;
            text-align: center;
            margin: 0;
            padding: 20px 0;
        }
        .game-section {
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { 
            color: #8A2BE2; 
            margin-bottom: 10px; 
            text-shadow: 2px 2px 0 #fff;
        }
        h2 {
            color: #6495ED; 
            margin-bottom: 20px;
        }
        #score-display { 
            font-size: 1.6em; 
            color: #6495ED; 
            margin-top: 15px; 
            font-weight: bold;
        }
        
        /* --- Karaoke Window (12 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î, ‡∏™‡∏µ‡∏Ñ‡∏£‡∏µ‡∏°) --- */
        #karaoke-window {
            width: 95%;
            max-width: 900px;
            height: 480px; 
            overflow: hidden; 
            margin: 20px 0;
            background-color: #FFFACD; 
            border-radius: 15px;
            border: 5px solid #6A5ACD;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        #lyrics-container {
            width: 100%;
            transition: transform 0.4s ease-out; 
            padding-top: 100px; 
        }
        
        .lyric-line {
            font-size: 1.8em; 
            font-weight: 600;
            line-height: 1.5;
            padding: 2px 20px;
            transition: color 0.3s, opacity 0.3s;
        }
        .current-line {
            color: #333; 
            opacity: 1;
            transform: scale(1.05);
        }
        .non-current-line {
            color: #A9A9A9; 
            opacity: 0.7;
        }
        .word {
            transition: color 0.1s;
            margin-right: 5px;
            display: inline-block;
        }
        .highlighted {
            color: #FF69B4; 
            text-shadow: 1px 1px 2px #F08080; 
        }
        .guess-word {
            color: #483D8B; 
            border-bottom: 3px dashed #483D8B; 
        }

        /* --- Controls & Menu Button Styles --- */
        #controls-container, #main-menu-page button {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .menu-button, button#playButton {
            padding: 18px 40px;
            font-size: 1.3em;
            background-color: #9370DB; 
            color: white;
            border: 4px solid #fff;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px #6A5ACD; 
            transition: all 0.1s;
            margin: 10px; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏á */
        }
        .menu-button:active, button#playButton:active {
            box-shadow: 0 1px #6A5ACD;
            transform: translateY(4px);
        }
        
        #choices-container {
            min-height: 60px;
        }
        .choice-button {
            padding: 15px 30px;
            font-size: 1.2em;
            margin: 0 10px;
            background-color: #B0E0E6; 
            color: #333;
            border: 3px solid #6495ED;
            border-radius: 40px;
            cursor: pointer;
            box-shadow: 0 3px #87CEEB;
            transition: all 0.1s;
            display: none; 
        }
        .choice-button.active {
            display: inline-block;
        }
        
        /* --- Summary Page --- */
        #summary-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100%;
            background: linear-gradient(135deg, #FFC0CB 0%, #ADD8E6 100%); 
            z-index: 1000;
            display: none; 
            padding: 20px;
            box-sizing: border-box;
            color: #333;
            overflow-y: auto;
        }
        .summary-content {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
        }
        #summary-list {
            margin-top: 20px;
            text-align: left;
        }
        .summary-item { 
            padding: 8px 0; 
            border-bottom: 1px dotted #ccc; 
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
        }
        .summary-word { font-weight: bold; width: 60%; } 
        .summary-status { width: 40%; text-align: right;} 
        .correct-ans { color: #3CB371; } 
        .wrong-ans { color: #FF6347; } 
    </style>
</head>
<body>
    
    <div id="main-menu-page" class="game-section">
        <h1>üé§ Sing & Spell Stars</h1>
        <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô</h2>
        <div id="song-list-container">
            <button class="menu-button" onclick="loadSongAndStartGame('jinglebells')">üé∂ Jingle Bells</button>
            <button class="menu-button" onclick="loadSongAndStartGame('wewish')">üéÑ We Wish You A Merry Christmas</button>
        </div>
    </div>

    <div id="game-page" class="game-section" style="display: none;">
        <h1>üé§ Sing & Spell Stars</h1>
        <h2 id="song-title-display"></h2> 
        
        <div id="score-display">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0</div>
        
        <div id="karaoke-window">
            <div id="lyrics-container">
                </div>
        </div>

        <div id="status">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</div>
        
        <div id="controls-container">
             <div id="choices-container">
                </div>
             <div id="start-button-container">
                <button id="playButton">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏Ñ‡∏≤‡∏£‡∏≤‡πÇ‡∏≠‡πÄ‡∏Å‡∏∞</button>
             </div>
        </div>
    </div>

    <div id="summary-page">
      <div class="summary-content">
        <h2 style="color: #483D8B;">üìú ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h2>
        <div style="font-size: 1.5em; margin-bottom: 20px;">
            **‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢:** <span id="final-score" style="color: #FF69B4;"></span>
        </div>
        <div id="summary-list">
             </div>
        <button onclick="goToMainMenu()" style="margin-top: 30px; background-color: #9370DB; color: white; padding: 15px 30px; border: none; border-radius: 30px; font-size: 1.2em;">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏•‡∏á
        // ----------------------------------------------------
        let audioContext;
        let isPlaying = false;
        const tempo = 120; // 120 BPM = 1 beat/0.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        const secondsPerBeat = 60 / tempo;
        let score = 0;
        let currentGapIndex = 0; 
        let currentLineIndex = -1;
        let musicStartTime = 0;
        let totalWordIndex = 0; 
        const guessResults = []; 
        let currentSongData = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô

        const noteFrequencies = {
            'C3': 130.81, 'D3': 146.83, 'E3': 164.81, 'F3': 174.61, 'G3': 196.00, 'A3': 220.00, 'B3': 246.94, 
            'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'Fs4': 369.99, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88, 
            'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, 
            'R': 0 
        };

        // ** ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î **
        const songsData = {
            "jinglebells": {
                title: "Jingle Bells (Adjusted Tempo)",
                data: [
                    // [‡πÇ‡∏ô‡πâ‡∏ï, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞, '‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå', ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏≤, {‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏≤ (Correct, Choices, Thai)}, Line Index]
                    
                    // Stanza 1: Dashing through the snow...
                    ['E4', 0.5, 'Dash', false, null, 1], ['E4', 0.5, 'ing', false, null, 1], ['E4', 1.0, 'through', false, null, 1], 
                    ['E4', 0.5, 'the', false, null, 1], ['E4', 0.5, 'snow,', true, { correct: 'snow,', choices: ['snow,', 'slow,'], thai: '‡∏´‡∏¥‡∏°‡∏∞' }, 1], ['R', 1.0, '', false, null, 1], // **GAP 1**
                    ['E4', 0.5, 'in', false, null, 1], ['E4', 0.5, 'a', false, null, 1], ['E4', 1.0, 'one-', false, null, 1], 
                    ['E4', 0.5, 'horse', false, null, 1], ['E4', 0.5, 'open', false, null, 1], ['R', 0.5, '', false, null, 1], ['G4', 1.5, 'sleigh!', false, null, 1], ['R', 0.5, '', false, null, 1],
                    
                    ['G4', 0.5, "O'er", false, null, 2], ['G4', 0.5, 'the', false, null, 2], ['G4', 1.0, 'fields', false, null, 2], 
                    ['G4', 0.5, 'we', false, null, 2], ['G4', 0.5, 'go,', false, null, 2], ['R', 1.0, '', false, null, 2], 
                    ['A4', 0.5, 'laugh', false, null, 2], ['A4', 0.5, 'ing', false, null, 2], ['A4', 1.0, 'all', false, null, 2], 
                    ['A4', 0.5, 'the', false, null, 2], ['A4', 0.5, 'way;', false, null, 2], ['R', 0.5, '', false, null, 2], ['E4', 1.5, 'Oh!', false, null, 2], ['R', 0.5, '', false, null, 2],
                    
                    ['Fs4', 0.5, 'Bells', true, { correct: 'Bells', choices: ['Bells', 'Balls'], thai: '‡∏Å‡∏£‡∏∞‡∏î‡∏¥‡πà‡∏á' }, 3], ['Fs4', 0.5, 'on', false, null, 3], ['Fs4', 1.0, 'bob-', false, null, 3], // **GAP 2**
                    ['Fs4', 0.5, 'tail', false, null, 3], ['Fs4', 0.5, 'ring,', false, null, 3], ['R', 1.0, '', false, null, 3], 
                    ['E4', 0.5, 'mak', false, null, 3], ['E4', 0.5, 'ing', false, null, 3], ['E4', 1.0, 'spirits', false, null, 3], 
                    ['E4', 0.5, 'bright,', false, null, 3], ['D4', 0.5, '', false, null, 3], ['R', 0.5, '', false, null, 3], ['D4', 1.5, 'Oh!', false, null, 3], ['R', 0.5, '', false, null, 3],
                    
                    ['C4', 0.5, 'what', false, null, 4], ['C4', 0.5, 'fun', false, null, 4], ['C4', 1.0, 'it', false, null, 4], 
                    ['C4', 0.5, 'is', false, null, 4], ['C4', 0.5, 'to', false, null, 4], ['R', 0.5, '', false, null, 4], 
                    ['D4', 0.5, 'ride', false, null, 4], ['D4', 0.5, 'and', false, null, 4], ['D4', 1.0, 'sing', true, { correct: 'sing', choices: ['sing', 'sink'], thai: '‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á' }, 4], // **GAP 3**
                    ['E4', 0.5, 'a', false, null, 4], ['E4', 0.5, 'sleigh', false, null, 4], ['R', 0.5, '', false, null, 4], ['G4', 1.5, 'ing', false, null, 4], ['R', 0.5, '', false, null, 4],
                    
                    // Chorus: Jingle bells, jingle bells... (Melody: E-E-E, E-E-E, E-G-C-D-E)
                    ['G4', 0.5, 'Jin', false, null, 5], ['G4', 0.5, 'gle', false, null, 5], ['G4', 1.0, 'bells,', false, null, 5], 
                    ['G4', 0.5, 'jin', false, null, 5], ['G4', 0.5, 'gle', false, null, 5], ['G4', 1.0, 'bells,', false, null, 5], 
                    ['G4', 0.5, 'jin', false, null, 5], ['B4', 0.5, 'gle', false, null, 5], ['D4', 0.5, 'all', false, null, 5], ['C4', 0.5, 'the', false, null, 5], 
                    ['A4', 1.5, 'way!', false, null, 5], ['R', 0.5, 'Oh,', true, { correct: 'Oh,', choices: ['Oh,', 'Go,'], thai: '‡πÇ‡∏≠‡πâ' }, 5], // **GAP 4**

                    ['G4', 0.5, 'what', false, null, 6], ['G4', 0.5, 'fun', false, null, 6], ['G4', 1.0, 'it', false, null, 6], 
                    ['F4', 0.5, 'is', false, null, 6], ['F4', 0.5, 'to', false, null, 6], ['F4', 0.5, 'ride', false, null, 6], 
                    ['F4', 0.5, 'in', false, null, 6], ['E4', 0.5, 'a', false, null, 6], ['E4', 0.5, 'one', false, null, 6], ['E4', 0.5, 'horse', false, null, 6], 
                    ['D4', 1.5, 'open', true, { correct: 'open', choices: ['open', 'oven'], thai: '‡πÄ‡∏õ‡∏¥‡∏î' }, 6], ['R', 0.5, 'sleigh!', false, null, 6], // **GAP 5**

                    // Chorus Repeat (Melody: F-F-F, F-F-F, F-E-D-C-F)
                    ['G4', 0.5, 'Jin', false, null, 7], ['G4', 0.5, 'gle', false, null, 7], ['G4', 1.0, 'bells,', false, null, 7], 
                    ['G4', 0.5, 'jin', false, null, 7], ['G4', 0.5, 'gle', false, null, 7], ['G4', 1.0, 'bells,', false, null, 7], 
                    ['G4', 0.5, 'jin', false, null, 7], ['B4', 0.5, 'gle', false, null, 7], ['D4', 0.5, 'all', false, null, 7], ['C4', 0.5, 'the', false, null, 7], 
                    ['A4', 1.5, 'way!', false, null, 7], ['R', 0.5, 'Oh,', false, null, 7], // **GAP 6**
                    
                    ['G4', 0.5, 'what', false, null, 8], ['G4', 0.5, 'fun', false, null, 8], ['F4', 1.0, 'it', false, null, 8], 
                    ['E4', 0.5, 'is', false, null, 8], ['E4', 0.5, 'to', false, null, 8], ['D4', 0.5, 'ride', false, null, 8], 
                    ['D4', 0.5, 'in', false, null, 8], ['D4', 0.5, 'a', false, null, 8], ['D4', 0.5, 'one', false, null, 8], ['D4', 0.5, 'horse', false, null, 8], 
                    ['C4', 2.0, 'open', false, null, 8], ['R', 1.0, 'sleigh!', false, null, 8], // **GAP 7**

                    // Bridge (Melody: G-G-G-G-A-A-A-A-G-G-F-D)
                    ['E4', 0.5, 'We', false, null, 9], ['E4', 0.5, 'are', false, null, 9], ['E4', 1.0, 'full', false, null, 9], 
                    ['E4', 1.0, 'of', false, null, 9], ['E4', 0.5, 'joy', true, { correct: 'joy', choices: ['joy', 'toy'], thai: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç' }, 9], ['R', 1.5, '', false, null, 9], // **GAP 8**
                    
                    ['G4', 0.5, 'Hear', false, null, 10], ['G4', 0.5, 'the', false, null, 10], ['G4', 1.0, 'merrily', true, { correct: 'merrily', choices: ['merrily', 'military'], thai: '‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô' }, 10], 
                    ['G4', 1.0, 'singing', false, null, 10], ['G4', 1.0, 'loud.', false, null, 10], ['R', 1.0, '', false, null, 10], // **GAP 9**
                    
                    ['D4', 0.5, 'And', false, null, 11], ['D4', 0.5, 'the', false, null, 11], ['D4', 1.0, 'bells', false, null, 11], 
                    ['D4', 1.0, 'go', false, null, 11], ['D4', 1.0, 'ding-a-ling', true, { correct: 'ding-a-ling', choices: ['ding-a-ling', 'sing-a-ling'], thai: '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏¥‡πà‡∏á' }, 11], ['R', 1.0, '', false, null, 11], // **GAP 10**

                    ['C4', 1.0, 'Christmas', false, null, 12], ['R', 0.5, 'time!', false, null, 12], ['R', 0.5, '', false, null, 12] 
                ]
            },
            "wewish": {
                title: "We Wish You A Merry Christmas (Adjusted Tempo)",
                data: [
                    // [‡πÇ‡∏ô‡πâ‡∏ï, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞, '‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå', ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏≤, {‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏≤ (Correct, Choices, Thai)}, Line Index]
                    // --- BARS 1-4 (‡πÇ‡∏ô‡πâ‡∏ï 0.5 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
                    ['G4', 0.5, 'We', false, null, 1], ['C5', 0.5, 'wish', false, null, 1], ['C5', 0.5, 'you', false, null, 1], ['D5', 0.5, 'a', false, null, 1], 
                    ['C5', 0.5, 'mer-', false, null, 1], ['B4', 0.5, 'ry', false, null, 1], ['A4', 0.5, 'Christ-', true, { correct: 'Christ-', choices: ['Christ-', 'Cross-'], thai: '‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå' }, 1], ['G4', 0.5, 'mas,', false, null, 1], // **GAP 1**
                    ['G4', 0.5, 'we', false, null, 2], ['C5', 0.5, 'wish', false, null, 2], ['C5', 0.5, 'you', false, null, 2], ['D5', 0.5, 'a', false, null, 2], 
                    ['C5', 0.5, 'mer-', false, null, 2], ['B4', 0.5, 'ry', false, null, 2], ['A4', 0.5, 'Christ-', false, null, 2], ['G4', 0.5, 'mas,', true, { correct: 'mas,', choices: ['mas,', 'man,'], thai: '‡∏°‡∏≤‡∏™' }, 2], // **GAP 2**

                    // --- BARS 5-8 (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÇ‡∏ô‡πâ‡∏ï Quarter Note 1.0)
                    ['E4', 0.5, 'we', false, null, 3], ['E4', 0.5, 'wish', false, null, 3], ['F4', 0.5, 'you', false, null, 3], ['F4', 0.5, 'a', false, null, 3], 
                    ['G4', 0.5, 'mer-', false, null, 3], ['E4', 0.5, 'ry', false, null, 3], ['D4', 0.5, 'Christ-', false, null, 3], ['C4', 0.5, 'mas', false, null, 3], 
                    ['R', 0.5, 'and', false, null, 4], ['G4', 0.5, 'a', false, null, 4], ['G4', 0.5, 'hap-', false, null, 4], ['G4', 0.5, 'py', true, { correct: 'py', choices: ['py', 'day'], thai: '‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç' }, 4], // **GAP 3**
                    ['A4', 1.0, 'New', false, null, 4], ['R', 0.5, 'Year!', false, null, 4], ['R', 0.5, 'Good', false, null, 4], // ‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡∏î‡∏≥ 1.0 + ‡∏ï‡∏±‡∏ß‡∏´‡∏¢‡∏∏‡∏î 0.5

                    // --- BARS 9-12 (‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡∏î‡∏≥ 1.0 ‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≥)
                    ['B4', 0.5, 'tid', true, { correct: 'tid', choices: ['tid', 'try'], thai: '‡∏Ç‡πà‡∏≤‡∏ß' }, 5], ['B4', 0.5, '-ings', false, null, 5], ['C5', 0.5, 'we', false, null, 5], ['A4', 0.5, 'bring', false, null, 5], // **GAP 4**
                    ['G4', 0.5, 'to', false, null, 6], ['D4', 0.5, 'you', false, null, 6], ['E4', 0.5, 'and', false, null, 6], ['F4', 0.5, 'your', false, null, 6], 
                    ['D4', 1.0, 'kin;', true, { correct: 'kin;', choices: ['kin;', 'king;'], thai: '‡∏ç‡∏≤‡∏ï‡∏¥' }, 6], ['G4', 1.0, 'Good', false, null, 6], // ‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡∏î‡∏≥ 1.0 **GAP 5**

                    // --- BARS 13-16 (‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡∏î‡∏≥ 1.0 + ‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡∏Ç‡∏≤‡∏ß 2.0)
                    ['D5', 0.5, 'tid', false, null, 7], ['D5', 0.5, '-ings', false, null, 7], ['E5', 0.5, 'for', false, null, 7], ['D5', 0.5, 'Christ-', false, null, 7], 
                    ['C5', 0.5, 'mas', false, null, 7], ['A4', 0.5, 'and', false, null, 7], ['A4', 0.5, 'a', false, null, 7], ['G4', 0.5, 'hap-', false, null, 7], 
                    ['F4', 0.5, 'py', false, null, 8], ['E4', 0.5, 'New', true, { correct: 'New', choices: ['New', 'Next'], thai: '‡πÉ‡∏´‡∏°‡πà' }, 8], ['R', 1.0, 'Year!', false, null, 8], // ‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡∏î‡∏≥ 1.0 **GAP 6**
                    ['G4', 2.0, 'We', false, null, 8], ['R', 2.0, '', false, null, 8], // ‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡∏Ç‡∏≤‡∏ß 2.0

                    // --- BARS 17-22 (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡πÅ‡∏•‡∏∞‡∏à‡∏ö)
                    ['G4', 0.5, 'wish', true, { correct: 'wish', choices: ['wish', 'wash'], thai: '‡∏õ‡∏£‡∏≤‡∏£‡∏ñ‡∏ô‡∏≤' }, 9], ['C5', 0.5, 'you', false, null, 9], ['D5', 0.5, 'a', false, null, 9], ['C5', 0.5, 'mer-', false, null, 9], // **GAP 7**
                    ['B4', 0.5, 'ry', false, null, 9], ['A4', 0.5, 'Christ-', false, null, 9], ['G4', 0.5, 'mas,', false, null, 9], ['G4', 0.5, 'we', false, null, 9], 
                    ['C5', 0.5, 'wish', false, null, 10], ['C5', 0.5, 'you', false, null, 10], ['D5', 0.5, 'a', false, null, 10], ['C5', 0.5, 'mer-', false, null, 10], 
                    ['B4', 0.5, 'ry', false, null, 11], ['A4', 0.5, 'Christ-', true, { correct: 'Christ-', choices: ['Christ-', 'Cross-'], thai: '‡∏Ñ‡∏£‡∏¥‡∏™‡∏ï‡πå' }, 11], ['G4', 0.5, 'mas,', false, null, 11], ['E4', 0.5, 'we', false, null, 11], // **GAP 8**
                    ['E4', 0.5, 'wish', false, null, 12], ['F4', 0.5, 'you', true, { correct: 'you', choices: ['you', 'your'], thai: '‡∏Ñ‡∏∏‡∏ì' }, 12], ['F4', 0.5, 'a', false, null, 12], ['G4', 0.5, 'mer-', false, null, 12], // **GAP 9**
                    ['E4', 0.5, 'ry', false, null, 12], ['D4', 0.5, 'Christ-', false, null, 12], ['C4', 1.0, 'mas', false, null, 12], ['R', 0.5, 'and', false, null, 12], // ‡πÇ‡∏ô‡πâ‡∏ï‡∏ï‡∏±‡∏ß‡∏î‡∏≥ 1.0
                    ['G4', 0.5, 'a', false, null, 13], ['G4', 0.5, 'hap-', false, null, 13], ['G4', 0.5, 'py', false, null, 13], ['A4', 1.0, 'New', false, null, 13], ['R', 0.5, 'Year!', true, { correct: 'Year!', choices: ['Year!', 'Here!'], thai: '‡∏õ‡∏µ' }, 13] // **GAP 10**
                ]
            }
        };


        // ----------------------------------------------------
        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Play Note) - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        // ----------------------------------------------------
        
        function playNote(frequency, startTime, duration) {
            if (frequency === 0) return; 
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.type = 'triangle'; 
            oscillator.frequency.setValueAtTime(frequency, startTime);
            const attackTime = 0.01;
            const releaseTime = 0.1;
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(0.5, startTime + attackTime); 
            gainNode.gain.linearRampToValueAtTime(0.5, startTime + duration - releaseTime);
            gainNode.gain.linearRampToValueAtTime(0, startTime + duration); 
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        }

        // ----------------------------------------------------
        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏•‡∏¢‡πå - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        // ----------------------------------------------------
        
        function initializeLyrics(songData) {
            const container = document.getElementById('lyrics-container');
            container.innerHTML = '';
            
            const linesData = {};
            songData.data.forEach(item => {
                const lineIndex = item[item.length - 1]; 
                if (!linesData[lineIndex]) {
                    linesData[lineIndex] = [];
                }
                linesData[lineIndex].push(item);
            });
            
            let wordCounter = 0;
            totalWordIndex = 0;
            
            // ‡πÉ‡∏ä‡πâ Object.keys.forEach ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏ô‡∏ï‡∏≤‡∏° Line Index ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
            Object.keys(linesData).sort((a, b) => a - b).forEach(lineIndex => {
                const lineData = linesData[lineIndex];
                const lineDiv = document.createElement('div');
                lineDiv.className = 'lyric-line non-current-line';
                lineDiv.id = 'line-' + lineIndex;
                
                lineData.forEach(([note, duration, word, isGap, gapData]) => {
                    if (word && word !== 'R') { 
                        const wordSpan = document.createElement('span');
                        wordSpan.className = 'word';
                        wordSpan.textContent = word.replace('R', '') + ' ';
                        
                        if (isGap) {
                            wordSpan.id = 'gap-word-' + wordCounter;
                            wordSpan.classList.add('guess-word');
                            wordSpan.textContent = '____ '; 
                            wordSpan.dataset.index = wordCounter;
                            wordSpan.dataset.correct = gapData.correct;
                            wordSpan.dataset.choices = JSON.stringify(gapData.choices);
                            wordSpan.dataset.thai = gapData.thai;
                            wordSpan.dataset.guessed = 'false'; 
                            wordCounter++;
                        } else {
                            wordSpan.id = 'synced-word-' + totalWordIndex;
                        }
                        
                        lineDiv.appendChild(wordSpan);
                        totalWordIndex++;
                    }
                });
                container.appendChild(lineDiv);
            });
            currentGapIndex = 0;
            
            const firstLine = document.getElementById('line-1');
            if(firstLine) {
                 firstLine.classList.remove('non-current-line');
                 firstLine.classList.add('current-line');
                 currentLineIndex = 1;
            }
        }

        function updateLyrics(index, delay) {
            setTimeout(() => {
                const previousWordElement = document.querySelector(`.lyric-line .highlighted`);
                if (previousWordElement) {
                    previousWordElement.classList.remove('highlighted');
                }

                const data = currentSongData.data[index];
                const word = data[2];
                const isGap = data[3];
                const lineIdx = data[5];
                
                // --- Scrolling Logic ---
                if (lineIdx && lineIdx !== currentLineIndex) {
                    const newLineElement = document.getElementById('line-' + lineIdx);
                    const oldLineElement = document.getElementById('line-' + currentLineIndex);
                    
                    if(oldLineElement) {
                        oldLineElement.classList.remove('current-line');
                        oldLineElement.classList.add('non-current-line');
                    }
                    
                    if (newLineElement) {
                        const lineTop = newLineElement.offsetTop;
                        const scrollOffset = 240; 
                        const scrollAmount = lineTop - scrollOffset;
                        
                        document.getElementById('lyrics-container').style.transform = `translateY(-${Math.max(0, scrollAmount)}px)`;
                        
                        newLineElement.classList.add('current-line');
                        newLineElement.classList.remove('non-current-line');
                        currentLineIndex = lineIdx;
                    }
                }

                // --- Highlighting ---
                if (word && word !== 'R') {
                    let wordElement = null;
                    
                    if (isGap) {
                        wordElement = document.getElementById('gap-word-' + currentGapIndex);
                    } else {
                        let textIndex = 0;
                        for (let i = 0; i < currentSongData.data.length; i++) {
                            const [n, d, w] = currentSongData.data[i];
                            if (w && w !== 'R') {
                                if (i === index) {
                                    wordElement = document.getElementById('synced-word-' + textIndex);
                                    break;
                                }
                                textIndex++;
                            }
                        }
                    }
                    
                    if (wordElement) {
                         wordElement.classList.add('highlighted');
                    }
                }
                
                // --- Gap Index Management (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß) ---
                if (isGap) {
                    const gapElement = document.getElementById('gap-word-' + currentGapIndex);
                    
                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô GAP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    const totalGaps = currentSongData.data.filter(item => item[3] === true).length;

                    const waitDurationMs = currentSongData.data[index][1] * secondsPerBeat * 1000;
                    
                    setTimeout(() => {
                        // 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Timeout ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö
                        if (gapElement && gapElement.dataset.guessed === 'false') {
                             handleTimeout(gapElement);
                        }
                        
                        // 2. ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Gap ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà (‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤)
                        currentGapIndex++;
                        if (currentGapIndex < totalGaps) { // ‡πÉ‡∏ä‡πâ totalGaps ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏≤
                            const nextGapElement = document.getElementById('gap-word-' + currentGapIndex);
                            if (nextGapElement) {
                                const choices = JSON.parse(nextGapElement.dataset.choices);
                                const correct = nextGapElement.dataset.correct;
                                showChoices(nextGapElement, choices, correct);
                            }
                        }
                    }, waitDurationMs);
                }

            }, delay);
        }

        function showChoices(wordElement, choices, correctWord) {
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = ''; 
            
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button active'; 
                button.textContent = choice;
                button.onclick = () => handleGuess(button, choice, correctWord, wordElement);
                choicesContainer.appendChild(button);
            });
        }

        function handleTimeout(wordElement) {
            score -= 1; 
            document.getElementById('score-display').textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`;
            wordElement.textContent = wordElement.dataset.correct + ' '; 
            wordElement.style.color = '#FF6347'; 
            wordElement.style.borderBottom = 'none'; 
            wordElement.dataset.guessed = 'true';

            guessResults.push({ word: wordElement.dataset.correct, thai: wordElement.dataset.thai, status: '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤', message: '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ö', correct: wordElement.dataset.correct });
            document.getElementById('choices-container').innerHTML = '';
        }

        function handleGuess(button, guessedWord, correctWord, wordElement) {
            if (wordElement.dataset.guessed === 'true') return;

            wordElement.dataset.guessed = 'true';
            const allChoiceButtons = document.getElementById('choices-container').querySelectorAll('.choice-button');
            allChoiceButtons.forEach(btn => btn.disabled = true);

            let resultStatus;

            if (guessedWord === correctWord) {
                score += 10; 
                resultStatus = '‡∏ñ‡∏π‡∏Å';
                wordElement.textContent = correctWord + ' ';
                wordElement.style.color = '#3CB371'; 
                wordElement.style.borderBottom = 'none';
            } else {
                score -= 1; 
                resultStatus = '‡∏ú‡∏¥‡∏î';
                wordElement.textContent = correctWord + ' '; 
                wordElement.style.color = '#FF6347'; 
                wordElement.style.borderBottom = 'none';
            }

            document.getElementById('score-display').textContent = `‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}`;
            
            guessResults.push({
                word: correctWord,
                thai: wordElement.dataset.thai,
                status: resultStatus,
                message: resultStatus === '‡∏ñ‡∏π‡∏Å' ? '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å' : '‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î',
                correct: correctWord
            });

            document.getElementById('choices-container').innerHTML = '';
        }
        
        // ----------------------------------------------------
        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤ (Menu & Summary) - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        // ----------------------------------------------------
        
        function showSummary() {
            document.getElementById('game-page').style.display = 'none';
            const summaryPage = document.getElementById('summary-page');
            summaryPage.style.display = 'flex';
            
            const summaryList = document.getElementById('summary-list');
            const finalScore = document.getElementById('final-score');
            
            summaryList.innerHTML = '';
            finalScore.textContent = score;

            const headerDiv = document.createElement('div');
            headerDiv.className = 'summary-item';
            headerDiv.style.fontWeight = 'bold';
            headerDiv.innerHTML = `<span class="summary-word">‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå / ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•</span><span class="summary-status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>`;
            summaryList.appendChild(headerDiv);

            guessResults.forEach(item => {
                const div = document.createElement('div');
                div.className = 'summary-item';
                const statusClass = item.status === '‡∏ñ‡∏π‡∏Å' ? 'correct-ans' : 'wrong-ans';
                
                let displayStatus;
                if (item.status === '‡∏ñ‡∏π‡∏Å') {
                    displayStatus = '‡∏ñ‡∏π‡∏Å';
                } else if (item.status === '‡∏ú‡∏¥‡∏î') {
                    displayStatus = '‡∏ú‡∏¥‡∏î';
                } else {
                    displayStatus = '‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤';
                }

                div.innerHTML = `<span class="summary-word">${item.word} (${item.thai})</span>
                                 <span class="summary-status ${statusClass}">${displayStatus}</span>`;
                summaryList.appendChild(div);
            });
        }
        
        function goToMainMenu() {
            document.getElementById('summary-page').style.display = 'none';
            document.getElementById('game-page').style.display = 'none';
            document.getElementById('main-menu-page').style.display = 'flex'; 
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            currentSongData = null;
            document.getElementById('score-display').textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0';
            document.getElementById('status').textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°';
            document.getElementById('choices-container').innerHTML = '';
            
            if (audioContext) {
                 audioContext.close();
                 audioContext = null;
            }
        }

        // ----------------------------------------------------
        // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        // ----------------------------------------------------

        function loadSongAndStartGame(songKey) {
            currentSongData = songsData[songKey];
            
            // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Å‡∏°‡πÄ‡∏û‡∏•‡∏¢‡πå
            document.getElementById('main-menu-page').style.display = 'none';
            document.getElementById('game-page').style.display = 'flex';
            document.getElementById('summary-page').style.display = 'none';
            
            // 2. ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏•‡∏á
            document.getElementById('song-title-display').textContent = currentSongData.title;
            
            // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° UI
            document.getElementById('start-button-container').style.display = 'block'; 
            document.getElementById('choices-container').style.display = 'none';
            document.getElementById('playButton').onclick = startGame; 

            initializeLyrics(currentSongData); // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á
            document.getElementById('lyrics-container').style.transform = `translateY(0)`;
        }


        function startGame() {
            if (!currentSongData) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á
            
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á Choices Container ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            document.getElementById('start-button-container').style.display = 'none';
            document.getElementById('choices-container').style.display = 'flex';
            
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    executeGameFlow();
                });
            } else {
                executeGameFlow();
            }
        }

        function executeGameFlow() {
            if (isPlaying) return;
            isPlaying = true;
            score = 0;
            currentGapIndex = 0;
            currentLineIndex = -1;
            guessResults.length = 0;
            document.getElementById('score-display').textContent = '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: 0';
            document.getElementById('status').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô...';
            
            initializeLyrics(currentSongData); // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà
            document.getElementById('lyrics-container').style.transform = `translateY(0)`;

            musicStartTime = audioContext.currentTime;
            let currentTime = musicStartTime;
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á GAP 1 ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏•‡∏á
            const firstGapElement = document.getElementById('gap-word-0');
            if (firstGapElement) {
                const choices = JSON.parse(firstGapElement.dataset.choices);
                const correct = firstGapElement.dataset.correct;
                showChoices(firstGapElement, choices, correct);
            }

            currentSongData.data.forEach((data, index) => {
                const frequency = noteFrequencies[data[0]];
                const duration = data[1] * secondsPerBeat;
                
                playNote(frequency, currentTime, duration);
                
                const delayMs = (currentTime - musicStartTime) * 1000;
                updateLyrics(index, delayMs);
                
                currentTime += duration;
            });

            const totalDuration = currentTime - musicStartTime;

            setTimeout(() => {
                isPlaying = false;
                document.getElementById('status').textContent = `‡∏à‡∏ö‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•...`;
                document.getElementById('choices-container').innerHTML = '';
                showSummary(); 
            }, totalDuration * 1000 + 500); 
        }

        // ----------------------------------------------------
        // 6. ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        // ----------------------------------------------------
        goToMainMenu(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
    </script>
</body>
</html>
